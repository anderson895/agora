<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Agora Video Meeting</title>
<script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 30px; background: #f8f8f8; }
  h2 { margin-bottom: 10px; }
  #controls { margin-bottom: 10px; }
  input, button { padding: 8px 12px; margin: 5px; border-radius: 6px; border: 1px solid #ccc; }
  button:disabled { opacity: 0.5; cursor: not-allowed; }
  #video-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
  video, div[id^="player-"], #local-player { width: 300px; height: 200px; background: black; border-radius: 8px; }
  #status { margin-top: 10px; padding: 10px; border-radius: 6px; background: #eee; }
  #status.success { background: #d1fae5; color: #065f46; }
  #status.error { background: #fee2e2; color: #991b1b; }
</style>
</head>
<body>
  <h2>Agora Video Meeting</h2>

  <div id="controls">
    <input type="text" id="roomName" placeholder="Enter room name">
    <button id="startMeeting">Start Meeting</button>
    <button id="leave" disabled>Leave</button>
  </div>

  <div id="status">Ready to start</div>
  <div id="video-container"></div>

<script>
const APP_ID = "b2e962fe791e4b23a34dee48010a733f"; // Your Agora App ID
let client = AgoraRTC.createClient({ mode: 'rtc', codec: 'vp8' });
let localTracks = { videoTrack: null, audioTrack: null };
let localPlayer;
const startBtn = document.getElementById('startMeeting');
const leaveBtn = document.getElementById('leave');
const videoContainer = document.getElementById('video-container');
const roomInput = document.getElementById('roomName');
const statusBox = document.getElementById('status');

function setStatus(message, type = '') {
  statusBox.textContent = message;
  statusBox.className = type ? `status ${type}` : 'status';
}

// Start Meeting (Create + Join in one)
startBtn.onclick = async () => {
  const channelName = roomInput.value.trim();
  if (!channelName) return setStatus("âš ï¸ Enter a room name first!", "error");

  try {
    setStatus("Requesting camera & microphone permission...");

    // âœ… Ask for permission with a small hack to trigger prompt reliably
    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    
    // Stop tracks immediately; we'll create Agora tracks separately
    stream.getTracks().forEach(track => track.stop());

    setStatus("Joining Agora channel...");
    await client.join(APP_ID, channelName, null, null);

    setStatus("Accessing your camera and microphone...");
    localTracks.audioTrack = await AgoraRTC.createMicrophoneAudioTrack();
    localTracks.videoTrack = await AgoraRTC.createCameraVideoTrack();

    // Display local video
    localPlayer = document.createElement('div');
    localPlayer.id = 'local-player';
    videoContainer.appendChild(localPlayer);
    localTracks.videoTrack.play(localPlayer);

    // Publish tracks to Agora
    await client.publish(Object.values(localTracks));
    setStatus(`âœ… Meeting started! Room: ${channelName}`, "success");

    startBtn.disabled = true;
    leaveBtn.disabled = false;

    // Handle remote users joining
    client.on('user-published', async (user, mediaType) => {
      await client.subscribe(user, mediaType);
      const player = document.createElement('div');
      player.id = 'player-' + user.uid;
      videoContainer.appendChild(player);
      if (mediaType === 'video') user.videoTrack.play(player);
      if (mediaType === 'audio') user.audioTrack.play();
    });

    // Handle remote users leaving
    client.on('user-unpublished', (user) => {
      const player = document.getElementById('player-' + user.uid);
      if (player) player.remove();
    });

  } catch (err) {
    console.error("Error:", err);

    // Stop any partially created tracks if error occurs
    Object.values(localTracks).forEach(track => {
      if (track) { track.stop(); track.close(); }
    });

    if (err.name === 'NotAllowedError') {
      setStatus("âŒ Camera or microphone access denied by system. Please allow permission.", "error");
    } else if (err.name === 'NotFoundError') {
      setStatus("âŒ No camera or microphone found.", "error");
    } else {
      setStatus("âŒ Failed to start meeting: " + err.message, "error");
    }

    startBtn.disabled = false;
    leaveBtn.disabled = true;
  }
};

// Leave Meeting
leaveBtn.onclick = async () => {
  setStatus("Leaving meeting...");
  for (let track of Object.values(localTracks)) {
    if (track) { track.stop(); track.close(); }
  }
  await client.leave();
  videoContainer.innerHTML = '';
  startBtn.disabled = false;
  leaveBtn.disabled = true;
  setStatus("ðŸ‘‹ You left the meeting", "success");
};
</script>
</body>
</html>
