<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agora Video Meeting with Kick Member</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
<script src="https://unpkg.com/agora-rtm-sdk@1.6.0/index.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-2 sm:p-4">

<h2 class="text-2xl sm:text-3xl font-bold mb-4 text-gray-800 text-center">
  Agora Video Meeting (Join Approval + Kick Member)
</h2>

<!-- Controls -->
<div id="controls" class="flex flex-col sm:flex-row flex-wrap gap-2 w-full max-w-xl mb-4">
  <input type="text" id="roomCode" placeholder="Enter room code"
         class="flex-1 p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-400 w-full sm:w-auto">
  <button id="createMeeting" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold px-4 py-2 rounded-md w-full sm:w-auto">
    Create Meeting
  </button>
  <button id="joinMeeting" class="bg-yellow-400 hover:bg-yellow-500 text-white font-semibold px-4 py-2 rounded-md w-full sm:w-auto">
    Request Join
  </button>
  <button id="leave" disabled class="bg-red-500 hover:bg-red-600 text-white font-semibold px-4 py-2 rounded-md disabled:opacity-50 disabled:cursor-not-allowed w-full sm:w-auto">
    Leave
  </button>
</div>

<!-- Status -->
<div id="status" class="w-full max-w-xl p-2 mb-4 bg-gray-200 rounded-md text-gray-800 text-center">
  Ready to start
</div>

<!-- Pending Requests (for host) -->
<div id="pendingRequests" class="w-full max-w-xl mb-4 hidden">
  <h3 class="font-semibold mb-2">Pending Join Requests:</h3>
  <ul id="requestsList" class="list-disc pl-5"></ul>
</div>

<!-- Video Container -->
<div id="video-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 w-full max-w-full pb-2"></div>

<script>
const APP_ID = "b2e962fe791e4b23a34dee48010a733f";
let client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
let rtmClient, rtmChannel;

let localTracks = { videoTrack: null, audioTrack: null };
let localPlayer, uid, roomCode;
let isCreator = false;
let approvalRequests = [];

const createBtn = document.getElementById("createMeeting");
const joinBtn = document.getElementById("joinMeeting");
const leaveBtn = document.getElementById("leave");
const videoContainer = document.getElementById("video-container");
const roomInput = document.getElementById("roomCode");
const statusBox = document.getElementById("status");
const pendingDiv = document.getElementById("pendingRequests");
const requestsList = document.getElementById("requestsList");

function setStatus(message, type = "") {
  statusBox.textContent = message;
  if (type === "success")
    statusBox.className = "w-full max-w-xl p-2 mb-4 bg-green-100 rounded-md text-green-700 text-center";
  else if (type === "error")
    statusBox.className = "w-full max-w-xl p-2 mb-4 bg-red-100 rounded-md text-red-700 text-center";
  else
    statusBox.className = "w-full max-w-xl p-2 mb-4 bg-gray-200 rounded-md text-gray-800 text-center";
}

// Pending Requests UI
function updateRequestsUI() {
  requestsList.innerHTML = "";
  if (approvalRequests.length === 0) {
    pendingDiv.classList.add("hidden");
    return;
  }
  pendingDiv.classList.remove("hidden");
  approvalRequests.forEach((req, index) => {
    const li = document.createElement("li");
    li.className = "flex justify-between items-center mb-1";
    li.innerHTML = `
      ${req.name || "Anonymous"}
      <span>
        <button class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded mr-1" onclick="approve(${index})">Approve</button>
        <button class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded" onclick="reject(${index})">Reject</button>
      </span>
    `;
    requestsList.appendChild(li);
  });
}

window.approve = async (index) => {
  const req = approvalRequests[index];
  approvalRequests.splice(index, 1);
  updateRequestsUI();
  setStatus(`‚úÖ Approved ${req.name}, joining meeting...`, "success");
  await joinMeeting(roomInput.value);
};

window.reject = (index) => {
  const req = approvalRequests[index];
  approvalRequests.splice(index, 1);
  updateRequestsUI();
  setStatus(`‚ùå Rejected ${req.name}`, "error");
};

// Initialize RTM
async function initRTM(uid, roomCode) {
  rtmClient = await AgoraRTM.createInstance(APP_ID);
  await rtmClient.login({ uid: String(uid) });
  rtmChannel = rtmClient.createChannel(roomCode);
  await rtmChannel.join();

  // Listen for "kick" messages
  rtmClient.on("MessageFromPeer", async (msg, peerId) => {
    if (msg.text === "KICK") {
      alert("üö´ You have been removed by the host.");
      await leaveMeeting();
      location.reload();
    }
  });
}

// Join Meeting
async function joinMeeting(room) {
  try {
    setStatus("Requesting camera & microphone...");
    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    stream.getTracks().forEach((t) => t.stop());

    client.on("user-published", async (user, mediaType) => {
      await client.subscribe(user, mediaType);
      let player = document.getElementById("player-" + user.uid);
      if (!player) {
        player = document.createElement("div");
        player.id = "player-" + user.uid;
        player.className = "aspect-video rounded-md overflow-hidden relative";
        videoContainer.appendChild(player);

        // Host can remove others
        if (isCreator) {
          const removeBtn = document.createElement("button");
          removeBtn.textContent = "Kick";
          removeBtn.className = "absolute top-2 left-2 bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded z-10";
          removeBtn.onclick = () => kickMember(user.uid);
          player.appendChild(removeBtn);
        }
      }
      if (mediaType === "video") user.videoTrack.play(player);
      if (mediaType === "audio") user.audioTrack.play();
    });

    client.on("user-unpublished", (user) => {
      const player = document.getElementById("player-" + user.uid);
      if (player) player.remove();
    });

    setStatus(`Joining room: ${room}...`);
    uid = await client.join(APP_ID, room, null, null);
    await initRTM(uid, room);

    localTracks.audioTrack = await AgoraRTC.createMicrophoneAudioTrack();
    localTracks.videoTrack = await AgoraRTC.createCameraVideoTrack();

    localPlayer = document.createElement("div");
    localPlayer.id = "local-player";
    localPlayer.className = "aspect-video rounded-md overflow-hidden relative";
    videoContainer.appendChild(localPlayer);
    await localTracks.videoTrack.play(localPlayer);
    await client.publish(Object.values(localTracks));

    setStatus(`‚úÖ Joined meeting: ${room}`, "success");
    joinBtn.disabled = true;
    createBtn.disabled = true;
    leaveBtn.disabled = false;
  } catch (err) {
    console.error(err);
    setStatus("‚ùå Join failed: " + err.message, "error");
  }
}

// Kick Member (RTM message)
async function kickMember(targetUid) {
  if (!rtmClient) return;
  setStatus(`üö´ Kicking member ${targetUid}...`, "error");
  await rtmClient.sendMessageToPeer({ text: "KICK" }, String(targetUid));
  const player = document.getElementById("player-" + targetUid);
  if (player) player.remove();
  setStatus(`‚ö†Ô∏è Member ${targetUid} was kicked.`, "error");
}

// Leave Meeting
async function leaveMeeting() {
  setStatus("Leaving meeting...");
  for (let track of Object.values(localTracks)) {
    if (track) {
      track.stop();
      track.close();
    }
  }
  await client.leave();
  if (rtmChannel) await rtmChannel.leave();
  if (rtmClient) await rtmClient.logout();

  videoContainer.innerHTML = "";
  localTracks = { videoTrack: null, audioTrack: null };
  localPlayer = null;
  joinBtn.disabled = false;
  createBtn.disabled = false;
  leaveBtn.disabled = true;
  setStatus("üëã You left the meeting", "success");
}

leaveBtn.onclick = leaveMeeting;

// Create Meeting
createBtn.onclick = async () => {
  isCreator = true;
  roomCode = Math.random().toString(36).substring(2, 8).toUpperCase();
  roomInput.value = roomCode;
  setStatus(`‚úÖ Room created: ${roomCode}`, "success");
  await joinMeeting(roomCode);
};

// Join Meeting (request approval)
joinBtn.onclick = () => {
  roomCode = roomInput.value.trim();
  if (!roomCode) return setStatus("‚ö†Ô∏è Enter a room code first!", "error");
  if (isCreator) {
    joinMeeting(roomCode);
  } else {
    const name = prompt("Enter your name to request join:");
    if (!name) return;
    approvalRequests.push({ name });
    updateRequestsUI();
    setStatus(`‚ö†Ô∏è Join request sent for approval`, "error");
  }
};
</script>
</body>
</html>
