<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Agora Video Meeting</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-2 sm:p-4">

<h2 class="text-2xl sm:text-3xl font-bold mb-4 text-gray-800 text-center">Agora Video Meeting</h2>

<!-- Controls -->
<div id="controls" class="flex flex-col sm:flex-row flex-wrap gap-2 w-full max-w-xl mb-4">
  <input type="text" id="roomCode" placeholder="Enter room code"
         class="flex-1 p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-400 w-full sm:w-auto">
  <button id="startMeeting" class="bg-yellow-400 hover:bg-yellow-500 text-white font-semibold px-4 py-2 rounded-md w-full sm:w-auto">
    Start / Join Meeting
  </button>
  <button id="leave" disabled class="bg-red-500 hover:bg-red-600 text-white font-semibold px-4 py-2 rounded-md disabled:opacity-50 disabled:cursor-not-allowed w-full sm:w-auto">
    Leave
  </button>
</div>

<!-- Status -->
<div id="status" class="w-full max-w-xl p-2 mb-4 bg-gray-200 rounded-md text-gray-800 text-center">
  Ready to start
</div>

<!-- Video Container -->
<div id="video-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 w-full max-w-full pb-2">
  <!-- Video elements go here -->
</div>

<script>
const APP_ID = "b2e962fe791e4b23a34dee48010a733f";
let client = AgoraRTC.createClient({ mode: 'rtc', codec: 'vp8' });
let localTracks = { videoTrack: null, audioTrack: null };
let localPlayer;

const startBtn = document.getElementById('startMeeting');
const leaveBtn = document.getElementById('leave');
const videoContainer = document.getElementById('video-container');
const roomInput = document.getElementById('roomCode');
const statusBox = document.getElementById('status');

function setStatus(message, type = '') {
  statusBox.textContent = message;
  if(type === "success") statusBox.className = "w-full max-w-xl p-2 mb-4 bg-green-100 rounded-md text-green-700 text-center";
  else if(type === "error") statusBox.className = "w-full max-w-xl p-2 mb-4 bg-red-100 rounded-md text-red-700 text-center";
  else statusBox.className = "w-full max-w-xl p-2 mb-4 bg-gray-200 rounded-md text-gray-800 text-center";
}

// Start / Join Meeting
startBtn.onclick = async () => {
  const roomCode = roomInput.value.trim();
  if (!roomCode) return setStatus("⚠️ Enter a room code first!", "error");

  try {
    setStatus("Requesting camera & microphone permission...");
    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    stream.getTracks().forEach(track => track.stop());

    // Register remote user events BEFORE joining
    client.on('user-published', async (user, mediaType) => {
      await client.subscribe(user, mediaType);

      let player = document.getElementById('player-' + user.uid);
      if (!player) {
        player = document.createElement('div');
        player.id = 'player-' + user.uid;
        player.className = "aspect-video rounded-md overflow-hidden";
        videoContainer.appendChild(player);
      }

      if (mediaType === 'video') user.videoTrack.play(player);
      if (mediaType === 'audio') user.audioTrack.play();
    });

    client.on('user-unpublished', (user) => {
      const player = document.getElementById('player-' + user.uid);
      if (player) player.remove();
    });

    setStatus(`Joining room: ${roomCode}...`);
    const uid = await client.join(APP_ID, roomCode, null, null);

    // Create local tracks
    localTracks.audioTrack = await AgoraRTC.createMicrophoneAudioTrack();
    localTracks.videoTrack = await AgoraRTC.createCameraVideoTrack();

    // Local video container
    localPlayer = document.getElementById('local-player');
    if (!localPlayer) {
      localPlayer = document.createElement('div');
      localPlayer.id = 'local-player';
      localPlayer.className = "aspect-video rounded-md overflow-hidden";
      videoContainer.appendChild(localPlayer);
    }
    await localTracks.videoTrack.play(localPlayer);
    await client.publish(Object.values(localTracks));

    setStatus(`✅ Joined meeting: ${roomCode}`, "success");
    startBtn.disabled = true;
    leaveBtn.disabled = false;

    // Subscribe to already-published users
    const remoteUsers = client.remoteUsers;
    for (let uid in remoteUsers) {
      const user = remoteUsers[uid];
      if (user.hasVideo) {
        let player = document.getElementById('player-' + user.uid);
        if (!player) {
          player = document.createElement('div');
          player.id = 'player-' + user.uid;
          player.className = "aspect-video rounded-md overflow-hidden";
          videoContainer.appendChild(player);
        }
        user.videoTrack.play(player);
      }
      if (user.hasAudio) {
        user.audioTrack.play();
      }
    }

  } catch (err) {
    console.error(err);
    Object.values(localTracks).forEach(track => { if (track) { track.stop(); track.close(); } });

    if (err.name === 'NotAllowedError') setStatus("❌ Camera or microphone access denied.", "error");
    else if (err.name === 'NotFoundError') setStatus("❌ No camera or microphone found.", "error");
    else setStatus("❌ Failed to join meeting: " + err.message, "error");

    startBtn.disabled = false;
    leaveBtn.disabled = true;
  }
};

// Leave Meeting
leaveBtn.onclick = async () => {
  setStatus("Leaving meeting...");
  for (let track of Object.values(localTracks)) { if (track) { track.stop(); track.close(); } }
  await client.leave();

  videoContainer.innerHTML = '';
  localTracks = { videoTrack: null, audioTrack: null };
  localPlayer = null;

  startBtn.disabled = false;
  leaveBtn.disabled = true;
  setStatus("👋 You left the meeting", "success");
};
</script>
</body>
</html>
