<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agora Video Meeting with Approval & Remove</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
<script src="https://unpkg.com/agora-rtm-sdk@1.6.0/index.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-2 sm:p-4">

<h2 class="text-2xl sm:text-3xl font-bold mb-4 text-gray-800 text-center">Agora Video Meeting (Join Approval)</h2>

<!-- Controls -->
<div id="controls" class="flex flex-col sm:flex-row flex-wrap gap-2 w-full max-w-xl mb-4">
  <input type="text" id="roomCode" placeholder="Enter room code"
         class="flex-1 p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-400 w-full sm:w-auto">

  <button id="createMeeting" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold px-4 py-2 rounded-md w-full sm:w-auto">
    Create Meeting
  </button>
  <button id="joinMeeting" class="bg-yellow-400 hover:bg-yellow-500 text-white font-semibold px-4 py-2 rounded-md w-full sm:w-auto">
    Request Join
  </button>
  <button id="leave" disabled class="bg-red-500 hover:bg-red-600 text-white font-semibold px-4 py-2 rounded-md disabled:opacity-50 disabled:cursor-not-allowed w-full sm:w-auto">
    Leave
  </button>
</div>

<div id="status" class="w-full max-w-xl p-2 mb-4 bg-gray-200 rounded-md text-gray-800 text-center">
  Ready to start
</div>

<div id="pendingRequests" class="w-full max-w-xl mb-4 hidden">
  <h3 class="font-semibold mb-2">Pending Join Requests:</h3>
  <ul id="requestsList" class="list-disc pl-5"></ul>
</div>

<div id="video-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 w-full max-w-full pb-2">
</div>

<script>
const APP_ID = "b2e962fe791e4b23a34dee48010a733f";

let client = AgoraRTC.createClient({ mode: 'rtc', codec: 'vp8' });
let rtmClient = null;
let rtmChannel = null;
let localTracks = { videoTrack:null, audioTrack:null };
let localPlayer;
let isCreator = false;
let approvalRequests = []; // { name, rtmUid } in real app, RTM UIDs used
let userRtmUid = Math.floor(Math.random()*1000000).toString(); // unique RTM UID for this user

const createBtn = document.getElementById('createMeeting');
const joinBtn = document.getElementById('joinMeeting');
const leaveBtn = document.getElementById('leave');
const videoContainer = document.getElementById('video-container');
const roomInput = document.getElementById('roomCode');
const statusBox = document.getElementById('status');
const pendingDiv = document.getElementById('pendingRequests');
const requestsList = document.getElementById('requestsList');

function setStatus(msg, type='') {
  statusBox.textContent = msg;
  if(type==="success") statusBox.className="w-full max-w-xl p-2 mb-4 bg-green-100 rounded-md text-green-700 text-center";
  else if(type==="error") statusBox.className="w-full max-w-xl p-2 mb-4 bg-red-100 rounded-md text-red-700 text-center";
  else statusBox.className="w-full max-w-xl p-2 mb-4 bg-gray-200 rounded-md text-gray-800 text-center";
}

// Pending requests UI
function updateRequestsUI() {
  requestsList.innerHTML='';
  if(approvalRequests.length===0){ pendingDiv.classList.add('hidden'); return; }
  pendingDiv.classList.remove('hidden');
  approvalRequests.forEach((req,index)=>{
    const li=document.createElement('li');
    li.className="flex justify-between items-center mb-1";
    li.innerHTML=`
      ${req.name || 'Anonymous'} 
      <span>
        <button class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded mr-1" onclick="approve(${index})">Approve</button>
        <button class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded" onclick="reject(${index})">Reject</button>
      </span>
    `;
    requestsList.appendChild(li);
  });
}

window.approve = async (index) => {
  const req = approvalRequests[index];
  approvalRequests.splice(index,1);
  updateRequestsUI();
  setStatus(`‚úÖ Approved ${req.name}`);
  // send message to participant to join
  if(rtmClient) rtmClient.sendMessageToPeer({text:"approved"}, req.rtmUid);
};

window.reject = (index) => {
  const req = approvalRequests[index];
  approvalRequests.splice(index,1);
  updateRequestsUI();
  setStatus(`‚ùå Rejected ${req.name}`, 'error');
  if(rtmClient) rtmClient.sendMessageToPeer({text:"rejected"}, req.rtmUid);
};

// Join Meeting
async function joinMeeting(roomCode) {
  try {
    setStatus("Requesting camera & microphone permission...");
    const stream = await navigator.mediaDevices.getUserMedia({ video:true,audio:true });
    stream.getTracks().forEach(track=>track.stop());

    // RTM setup
    rtmClient = await AgoraRTM.createInstance(APP_ID);
    await rtmClient.login({uid:userRtmUid});
    rtmClient.on('MessageFromPeer', async ({text},peerId)=>{
      if(text==="force-leave"){
        alert("‚ö†Ô∏è You were removed by host");
        await leaveMeeting();
      }
      if(text==="approved"){
        setStatus("‚úÖ Your join request approved, joining meeting...", "success");
        joinBtn.disabled = true;
        await rtcJoin(roomCode);
      }
      if(text==="rejected"){
        setStatus("‚ùå Your join request was rejected", "error");
      }
    });

    if(isCreator){
      // join channel as host
      await rtcJoin(roomCode);
    }

  } catch(err){
    console.error(err);
    setStatus("‚ùå Failed: "+err.message,"error");
  }
}

async function rtcJoin(roomCode){
  client.on('user-published', async (user, mediaType) => {
    await client.subscribe(user, mediaType);
    let player = document.getElementById('player-'+user.uid);
    if(!player){
      player = document.createElement('div');
      player.id = 'player-'+user.uid;
      player.className="aspect-video rounded-md overflow-hidden relative";
      videoContainer.appendChild(player);

      if(isCreator){
        const removeBtn=document.createElement('button');
        removeBtn.textContent="Remove";
        removeBtn.className="absolute top-2 left-2 bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded z-10";
        removeBtn.onclick=()=>forceRemove(user.uid);
        player.appendChild(removeBtn);
      }
    }
    if(mediaType==='video') user.videoTrack.play(player);
    if(mediaType==='audio') user.audioTrack.play();
  });

  client.on('user-unpublished',(user)=>{
    const player=document.getElementById('player-'+user.uid);
    if(player) player.remove();
  });

  setStatus(`Joining room: ${roomCode}...`);
  const uid = await client.join(APP_ID, roomCode, null, null);
  localTracks.audioTrack = await AgoraRTC.createMicrophoneAudioTrack();
  localTracks.videoTrack = await AgoraRTC.createCameraVideoTrack();

  localPlayer = document.getElementById('local-player');
  if(!localPlayer){
    localPlayer=document.createElement('div');
    localPlayer.id='local-player';
    localPlayer.className="aspect-video rounded-md overflow-hidden relative";
    videoContainer.appendChild(localPlayer);
  }
  await localTracks.videoTrack.play(localPlayer);
  await client.publish(Object.values(localTracks));

  setStatus(`‚úÖ Joined meeting: ${roomCode}`, "success");
  joinBtn.disabled=true; createBtn.disabled=true; leaveBtn.disabled=false;
}

// Force remove participant (host)
async function forceRemove(uid){
  const player=document.getElementById('player-'+uid);
  if(player) player.remove();

  const user = client.remoteUsers[uid];
  if(user){
    user.audioTrack?.stop();
    user.videoTrack?.stop();
    user.videoTrack?.close();
  }

  // send RTM message to participant to leave
  const peer = approvalRequests.find(x=>x.uid===uid);
  if(peer && rtmClient){
    await rtmClient.sendMessageToPeer({text:"force-leave"}, peer.rtmUid);
  }

  setStatus(`‚ö†Ô∏è Member ${uid} was removed by host`, 'error');
}

// Create Meeting
createBtn.onclick = async () => {
  isCreator = true;
  const code = Math.random().toString(36).substring(2,8).toUpperCase();
  roomInput.value = code;
  setStatus(`‚úÖ Room created: ${code}`, "success");
  await joinMeeting(code);
};

// Join Meeting (request approval)
joinBtn.onclick = () => {
  const roomCode = roomInput.value.trim();
  if(!roomCode) return setStatus("‚ö†Ô∏è Enter a room code first!", "error");
  if(isCreator){
    rtcJoin(roomCode);
  } else {
    const name = prompt("Enter your name:");
    if(!name) return;
    approvalRequests.push({name, rtmUid:userRtmUid});
    updateRequestsUI();
    setStatus("‚ö†Ô∏è Join request sent for approval",'error');
  }
};

// Leave Meeting
async function leaveMeeting(){
  setStatus("Leaving meeting...");
  for(let track of Object.values(localTracks)){ if(track){ track.stop(); track.close(); } }
  await client.leave();
  if(rtmClient) await rtmClient.logout();
  videoContainer.innerHTML='';
  localTracks={videoTrack:null,audioTrack:null};
  localPlayer=null;
  joinBtn.disabled=false;
  createBtn.disabled=false;
  leaveBtn.disabled=true;
  setStatus("üëã You left the meeting","success");
}

leaveBtn.onclick=leaveMeeting;
</script>
</body>
</html>
